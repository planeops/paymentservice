name: Self-hosted test
on:
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: [nodejs]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compilation
        run: find . -name "*.js" -exec node --check {} +

      - name: Run gitleaks scan
        run: gitleaks detect --source . --exit-code 1 \ 
          --report-format sarif --report-path gitleaks.sarif

#      - name: Upload SARIF to GitHub Security
#        uses: github/codeql-action/upload-sarif@v3
#        with:
#          sarif_file: gitleaks.sarif

#      - name: SonarQube Scan
#        uses: sonarsource/sonarqube-scan-action@master
#        env:
#          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
#          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
#
#      - name: SonarQube Quality Gate check
#        uses: sonarsource/sonarqube-quality-gate-action@master
#        with:
#          pollingTimeoutSec: 600
#        env:
#          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
#          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
#
#      - name: Run Trivy vulnerability scanner in repo mode
#        uses: aquasecurity/trivy-action@0.28.0
#        with:
#          scan-type: 'fs'
#          ignore-unfixed: true
#          format: 'sarif'
#          output: 'trivy-fs.sarif'
#          severity: 'CRITICAL'

      - name: Build Image
        env:
          BUILDKIT_ADDR: tcp://buildkit-service.buildkit.svc.cluster.local:1234
          S3_ENDPOINT: http://minio.minio.svc.cluster.local:9000
          SERVICE_NAME: paymentservice
        run: |
          buildctl --addr=${BUILDKIT_ADDR} build \
            --frontend=dockerfile.v0 \
            --local context=. \
            --local dockerfile=. \
            --export-cache type=s3,mode=max,name=${SERVICE_NAME},endpoint_url=${S3_ENDPOINT},use_path_style=true \
            --import-cache type=s3,name=${SERVICE_NAME},endpoint_url=${S3_ENDPOINT},use_path_style=true \
            --output type=oci,dest=image.tar